<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">remote-device-logger/index.js | remote-device-logger</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/ygoto3/remote-device-logger"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/remote-device-logger/index.js~RemoteDeviceLogger.html">RemoteDeviceLogger</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">remote-device-logger/index.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// @flow

/*::
export type RemoteDeviceLoggerParams = {
  debug?: boolean;
  stdout?: boolean;
  element?: HTMLElement;
  webSocketUrl?: string;
  display?: boolean;
};
*/

/**
 * Create a logger
 * @example
 * const logger = new RemoteDeviceLogger();
 * logger.log(&apos;Log A&apos;, &apos;Log B&apos;);
 */
export default class RemoteDeviceLogger {
  /*::
  _logPool: string[];
  _stdout: boolean;
  _element: HTMLElement;
  _connection: WebSocket;
  */

  /**
   * @param {Object} params
   * @param {boolean} [params.debug=true] debug
   * @param {boolean} [params.stdout=true] stdout
   * @param {HTMLElement} [params.element] element 
   * @param {string} [params.webSocketUrl] webSocketUrl
   * @param {boolean} [params.display] display
   */
  constructor({
    debug = true,
    stdout = true,
    element,
    webSocketUrl,
    display,
  }/*: RemoteDeviceLoggerParams*/ = {}) {
    /**
     * The condition if print a log message to the standard output
     * @private
     * @type {boolean}
     */
    this._stdout = stdout;
    if (debug) {
      /**
       * The pool area to store log messages
       * @private
       * @type {Array}
       */
      this._logPool = [];
      this._catchAllErrors();
      if (typeof WebSocket === &apos;function&apos; &amp;&amp; webSocketUrl) {
        this._connectWebSocket(webSocketUrl);
      }
      if (element) {
        this._createElement(element, display);
      }
    }
  }

  /**
   * Connect to a WebSocket server where you want to send a log
   * @private
   * @param {string} url The URL of a WebSocket server 
   */
  _connectWebSocket(url/*: string*/) {
    const connection = new WebSocket(url);
  
    connection.onopen = () =&gt; {
      const mes = &apos;WebSocket opened&apos;;
      this.print(mes);
      if (!this._logPool) return;
      this.sendLog(this._logPool);
      this.sendLog([mes]);
      this._logPool.unshift(mes);  
      this.writeToElement(this._logPool);
    };

    connection.onerror = () =&gt; {
      this.log(&apos;WebSocket error&apos;);
    };
    
    connection.onmessage = e =&gt; {
      this.log(&apos;WebSocket message:&apos;, e.data);
    };

    connection.onclose = e =&gt; {
      this.log(&apos;WebSocket closed&apos;);
    };

    /**
     * The WebSocket connection
     * @private
     * @type {Object}
     */
    this._connection = connection;
  }

  /**
   * Create an element node to contain logs for display
   * @private
   * @param {HTMLElement} parentElement The parent element of the log node 
   * @param {boolean} display The initial state of the logs&apos; appearance 
   */
  _createElement(parentElement/*: HTMLElement*/, display/*: boolean*/ = true) {
    const element = document.createElement(&apos;p&apos;);
    element.style.position = &apos;absolute&apos;;
    element.style.top = &apos;0&apos;;
    element.style.left = &apos;0&apos;;
    element.style.width = &apos;50%&apos;;
    element.style.height = &apos;100%&apos;;
    element.style.backgroundColor = &apos;rgba(0,0,0,.8)&apos;;
    element.style.color = &apos;white&apos;;
    element.style.wordWrap = &apos;break-word&apos;;
    element.style.padding = &apos;1em&apos;;
    element.style.lineHeight = &apos;1.4em&apos;;

    /**
     * The log container element
     * @private
     * @type {HTMLElement}
     */
    this._element = element;

    if (!display) this.hide();
    this.writeToElement(this._logPool);
    parentElement.appendChild(element);
  }

  /**
   * Add an event lister to window to catch all errors happening on the browser
   * @private
   */
  _catchAllErrors() {
    if (typeof window === &apos;undefined&apos;) return;
    window.onerror = (message, fileName, lineNumber, columnNumber) =&gt; {
      var errorInfo = {
        message,
        fileName,
        lineNumber,
        columnNumber,
        location: location.href,
        userAgent: navigator.userAgent
      };
      this.log(JSON.stringify(errorInfo));
    };
  }

  /**
   * Log messages
   * @param {...any} messages Log messages
   */
  log(...messages/*: any[]*/) {
    this.print(...messages);
    if (!this._logPool) return;

    const mes = messages.join(&apos; &apos;);
    this._logPool.unshift(mes);  

    this.writeToElement(this._logPool);
    this.sendLog([mes]);
  }

  /**
   * Print messages
   * @param {...any} messages Messages to print
   */
  print(...messages/*: any[]*/) {
    if (!this._stdout) return;
    console.log(...messages);
  }

  /**
   * Send log messages
   * @param {string[]} messages Messages to send
   */
  sendLog(messages/*: string[]*/) {
    if (!this._connection || this._connection.readyState !== WebSocket.OPEN) {
      return;
    }
    this._connection.send(messages.join(&apos; &apos;));
  }

  /**
   * Write log messages to the log container element
   * @param {string[]} messages Messages to write
   */
  writeToElement(messages/*: string[]*/) {
    if (!this._element) return;
    this._element.innerHTML = messages.join(&apos;&lt;br /&gt;&apos;);
  }

  /**
   * Toggle the log container element
   */
  toggle() {
    if (!this._element) return;
    if (this._element.style.display === &apos;none&apos;) {
      this.show();
    } else {
      this.hide();
    }
  }

  /**
   * Show the log container element
   */
  show() {
    if (!this._element) return;
    this._element.style.display = &apos;&apos;;
    this._element.style.visibility = &apos;&apos;;
  }

  /**
   * Hide the log container element
   */
  hide() {
    if (!this._element) return;
    this._element.style.display = &apos;none&apos;;
    this._element.style.visibility = &apos;hidden&apos;;
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
